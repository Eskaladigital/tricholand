---
description: Regla obligatoria sobre el origen de imágenes en el proyecto. Leer SIEMPRE antes de tocar cualquier imagen o componente <Image>.
globs:
  - src/**/*.tsx
  - src/**/*.ts
  - src/lib/storage.ts
  - src/content/**
  - src/components/**
alwaysApply: true
---

# REGLA DE ORO — ORIGEN DE IMÁGENES

Este proyecto tiene **dos orígenes de imágenes** que NO se deben mezclar jamás.

## LOCAL — `public/images/`

Estas secciones usan imágenes estáticas servidas desde `public/images/`:

- **Home** → `HeroSection.tsx`, `CatalogPreview.tsx`
- **Variedades** → `src/content/varieties/es/data.ts` (paths `/images/varieties/...`, `/images/vivero/...`, `/images/products/...`)
- **Sobre nosotros** → 7 páginas de idioma (`sobre-nosotros`, `about-us`, `uber-uns`, etc.)
- **Logo** → Header.tsx y Footer.tsx (`/images/icons/logo_tricho_yellow_200_200.webp`)
- **OG Image** → layouts (`/images/og-image.webp`)

**NO mover estas imágenes a Supabase.**

## SUPABASE STORAGE — URLs remotas

Estas secciones usan imágenes de Supabase Storage:

- **Tienda (productos)** → Las URLs vienen de la base de datos (`products.images`), bucket `plants`. Se procesan con `resolveProductImageUrl()` en `src/lib/actions/products.ts`.
- **Blog (artículos)** → Usan `getBlogImageUrl()` de `src/lib/storage.ts`, bucket `blog`.

**NO mover estas imágenes a `public/`.**

## Regla de `<Image>` y `unoptimized`

- Todas las imágenes de **Supabase** (tienda y blog) DEBEN llevar `unoptimized` (sin condiciones).
- Si no se pone `unoptimized`, Next.js intenta optimizar la imagen remota a través de su proxy, y si falla → **ERROR 500**.
- Las imágenes locales de `public/` también llevan `unoptimized` en este proyecto.

```tsx
// CORRECTO — imagen de producto (Supabase)
<Image src={product.images[0].url} alt="..." fill unoptimized />

// CORRECTO — imagen local (public/)
<Image src="/images/varieties/Trichocereus_Pachanoi_1.webp" alt="..." fill unoptimized />

// INCORRECTO — NUNCA hacer esto con imágenes de Supabase
<Image src={product.images[0].url} alt="..." fill unoptimized={url.startsWith('http')} />
```

## Helpers en `src/lib/storage.ts`

| Función | Uso | Bucket |
|---------|-----|--------|
| `getPlantImageUrl(path)` | Productos de tienda (cuando no viene URL completa) | `plants` |
| `getBlogImageUrl(path)` | Artículos del blog | `blog` |
| `resolveProductImageUrl(url)` | Passthrough — devuelve URL tal cual | — |

## Clientes Supabase — `createClient` vs `createApiClient`

Este proyecto tiene **dos clientes Supabase** y es CRÍTICO usar el correcto:

| Cliente | Archivo | ¿Necesita cookies? | Usar en... |
|---------|---------|---------------------|------------|
| `createClient()` | `src/lib/supabase/server.ts` | SÍ (usa `cookies()`) | Server Components en **runtime** (con request HTTP), admin |
| `createApiClient()` | `src/lib/supabase/api.ts` | NO | `generateStaticParams`, API routes, **build time**, lecturas públicas |

### Por qué importa (causa de ERROR 500)

`generateStaticParams()` se ejecuta en **build time**, donde NO hay request HTTP ni cookies.
Si una función dentro de `generateStaticParams` usa `createClient()` (con cookies), falla silenciosamente
y devuelve `[]`. Resultado: **0 páginas de producto generadas** → el usuario visita la URL → 500.

**Regla:** Las funciones de **lectura pública** (getActiveProducts, getProductBySlug, etc.) DEBEN usar
`createApiClient()` para que funcionen tanto en build como en runtime.

```typescript
// CORRECTO — lectura pública, funciona en build time
export async function getActiveProducts() {
  const supabase = createApiClient()  // ← SIN cookies
  // ...
}

// INCORRECTO — falla en build time (generateStaticParams)
export async function getActiveProducts() {
  const supabase = await createClient()  // ← NECESITA cookies → falla en build
  // ...
}
```

### Configuración SSG para páginas de producto

Las páginas de detalle de producto llevan estas exports para generarse estáticas con revalidación:

```typescript
export const dynamicParams = true   // Permitir slugs no pre-generados (ISR)
export const revalidate = 60        // Revalidar cada 60 segundos
```

## Resumen rápido

| Sección | Origen imágenes | ¿Supabase? | Cliente Supabase |
|---------|-----------------|------------|------------------|
| Home, Variedades, Sobre nosotros, Logo, OG | `public/images/` | NO | — |
| Tienda (productos) | Supabase `plants` | SÍ | `createApiClient()` |
| Blog (artículos) | Supabase `blog` | SÍ | Según contexto |
